---
title: "Subjective and autonomic nervous system responses to affective pictures in people with frequent nightmares"
output: html_notebook
---

```{r setup, include=FALSE}
if (!require(tidyverse)) install.packages("tidyverse")
if (!require(lme4)) install.packages("lme4")
if (!require(lmerTest)) install.packages("lmerTest")
if (!require(patchwork)) install.packages("patchwork")

library(tidyverse)
library(fs) # Part of extended tidyverse
library(lme4)
library(lmerTest)
library(patchwork)
```

# Aims

Theories suggest that people with frequent nightmares may have disturbed emotional processing, however this claim has not been supported by experimental evidence. This research investigates the following claims: 
People with frequent nightmares...  
A) ...have a heightened reactivity to disturbing stimuli  
B) ...have a slower habituation to disturbing stimuli

# Methods
Data was collected from participants with and without frequent nightmares. After a first accommodating night, participants were exposed to neutral and negative IAPS pictures in three blocks, while skin conductance and electrocardiogram was recorded. Arousal and valence of the pictures were evaluated after exposure. Subsequently, participant spent a night at the sleep lab, and took part in a recall session in the morning when where New pictures were shown along with the original ones.

# Data analysis strategy
- We use linear mixed-effects modeling using the lme4 package
- The random structure is determined by the Zuur (2009) method to determine the random and fixed structure
- Outcome variables are **subjective arousal, valence, skin conductance response (SCR), and heart rate deceleration (HRD)** (see processing details for each outcome measure below)
- We used **group** (control/nightmare) **block** (1/2/3) **picture** (neutral/negative) variables as fixed effects
- We start with a full model, and remove effects sequentially that does not contribute to the model
- Model comparisons are based on BIC: difference that are larger than 2 are considered important.

```{r data read, echo=FALSE, message=FALSE, warning=FALSE}
participants <- read_csv("analysis_data/participants.csv")
marker_wo_time <- 
    read_csv("analysis_data/markers.csv") %>% 
    # Drop training pictures
    drop_na(block)
                    
markers <- 
    read_csv("all_data/marker/all_triggers.csv", col_types = "cidiiiiiic") %>%
    mutate(id = if_else(str_length(id) == 1, paste0("0",id), id)) %>% 
    # Drop training pictures
    drop_na(block)

scr_data <- read_csv("analysis_data/scr_era.csv")
hr_data <- read_csv("all_data/hr/hr_cubic.csv")

# Extraction picture sets from marker data
pic_sets <- 
    marker_wo_time %>% 
    drop_na(block) %>% 
    filter(session == "emot") %>%
    select(id, stimulus) %>% 
    inner_join(participants %>% select(id, pic_set), by = "id") %>% 
    distinct(stimulus, pic_set) %>% 
    arrange(pic_set)

set_a <- pic_sets %>% filter(pic_set == "A") %>% pull(stimulus)
set_b <- pic_sets %>% filter(pic_set == "B") %>% pull(stimulus)

```

## Prepare data
```{r prepare scr data}
scr_era <-
    scr_data %>% 
    group_by(id) %>% 
    # Standardize values, sqrt + standardize values
    mutate(scr_std = scale(scr),
           scr_sqrt = sqrt(scr) %>% scale()) %>% 
    ungroup() %>% 
    # Remove outliers larger that 3.5 sds
    filter(abs(scr_std) < 3.5) %>% 
    # Add whether a picture in the recall session is New or not
    mutate(novelty = case_when(
               session == "recall" & pic_set == "A" & stimulus %in% set_a ~ "Old",
               session == "recall" & pic_set == "A" & !(stimulus %in% set_a) ~ "New",
               session == "recall" & pic_set == "B" & stimulus %in% set_b ~ "Old",
               session == "recall" & pic_set == "B" & !(stimulus %in% set_b) ~ "New",
               TRUE ~ NA_character_) %>% 
               factor(., levels = c("Old", "New"))) %>% 
    mutate(block = if_else(session == "recall", NA_integer_, block),
           picture = factor(picture, levels = c("Neutral", "Negative"))) 

# Create a df where data is aggregated for participants by session, block, group, etc.
df_sum <-
    scr_era %>% 
    group_by(id, session, block, group, picture, novelty) %>% 
    summarise(scr = mean(scr_sqrt, na.rm = TRUE),
              arousal = mean(arousal, na.rm = TRUE),
              valence = mean(valence, na.rm = TRUE)) %>% 
    ungroup()

# This dataset is needed for the model that contains sleeping (or is it?)

sleep_df <-
    scr_era %>% 
    filter(session == "emot" & block == 3L |
               session == "recall" & novelty == "Old") %>% 
    mutate(sleep = case_when(session == "emot" ~ "pre-sleep",
                             session == "recall" ~ "post-sleep") %>% 
               factor(., c("pre-sleep", "post-sleep"))) %>% 
    select(-session, -block, -novelty) %>% 
    group_by(id, group, picture, sleep) %>% 
    summarise(scr = mean(scr_sqrt, na.rm = TRUE),
              arousal = mean(arousal, na.rm = TRUE),
              valence = mean(valence, na.rm = TRUE)) %>% 
    ungroup()

sleep_sum <-
    scr_era %>% 
    filter(session == "emot" & block == 3L |
           session == "recall" & novelty == "Old") %>% 
    mutate(sleep = case_when(session == "emot" ~ "pre-sleep",
                             session == "recall" ~ "post-sleep") %>% 
               factor(., c("pre-sleep", "post-sleep"))) %>% 
    select(-session, -block, -novelty) %>% 
    group_by(group, picture, sleep) %>% 
    summarise(scr_mean = mean(scr_sqrt, na.rm = TRUE),
              scr_se = sd(scr_sqrt, na.rm = TRUE)/sqrt(n()),
              arousal_mean = mean(arousal, na.rm = TRUE),
              arousal_se = sd(arousal, na.rm = TRUE)/sqrt(n()),
              valence_mean = mean(valence, na.rm = TRUE),
              valence_se = sd(valence, na.rm = TRUE)/sqrt(n())) %>% 
    ungroup()

skimr::skim(df_sum)
```

# Subjective arousal

```{r plot subjective arousal, echo=FALSE}
# Subjective arousal
plot_emot_arousal <-
    scr_era %>%
    filter(session == "emot") %>% 
    mutate(session = case_when(session == "emot" ~ "Emotion induction",
                               session == "recall" ~ "Recall")) %>% 
    group_by(session, block, group, picture) %>% 
    summarise(Mean = mean(arousal, na.rm = TRUE),
              Se = sd(arousal, na.rm = TRUE)/sqrt(n())) %>% 
    ggplot() +
        aes(x = block, y = Mean, group = picture, ymin = Mean - Se, ymax = Mean + Se) +
        geom_point() +
        geom_errorbar(width = .2) +
        geom_line(aes(linetype = picture), size = 1) +
        coord_cartesian(ylim = c(1, 9)) +
        scale_x_continuous("Block", breaks = 1:3) +
        scale_y_continuous("Mean (SEM) of subjective arousal") +
        guides(linetype = "none") +
        facet_grid(group ~ session) +
        theme(strip.text.y = element_blank())

plot_recall_arousal <-
    scr_era %>%
    filter(session == "recall") %>% 
    mutate(session = case_when(session == "emot" ~ "Emotion induction",
                               session == "recall" ~ "Recall")) %>% 
    group_by(session, group, picture, novelty) %>% 
    summarise(Mean = mean(arousal, na.rm = TRUE),
              Se = sd(arousal, na.rm = TRUE)/sqrt(n())) %>% 
    ggplot() +
        aes(x = novelty, y = Mean, group = picture, ymin = Mean - Se, ymax = Mean + Se) +
        geom_point() +
        geom_errorbar(width = .2) +
        geom_line(aes(linetype = picture), size = 1) +
        coord_cartesian(ylim = c(1, 9)) +
        scale_x_discrete("Novelty") +
        scale_y_continuous(NULL) +
        facet_grid(group ~ session) +
        theme(axis.text.y = element_blank(),
              axis.ticks = element_blank()) +
    labs(linetype = "Picture")

plot_emot_arousal + 
    plot_recall_arousal +
    plot_layout(widths = c(3,2))

```

```{r modeling arousal}
arousal_lm <- lm(arousal ~ group * block * picture, data = scr_era)
arousal_i <- lmer(arousal ~ group * block * picture + (1 | id), data = scr_era)
arousal_is <- lmer(arousal ~ group * block * picture + (block : group : picture | id), data = scr_era)

# Remove 3 way interaction
arousal_best <- arousal_i
# Note that we use the random intercept model, however the random intercept+slope model may have a better fit (although it fails to converge properly). The optimal random structure is yet to be found.
arousal_3 <- update(arousal_best, . ~ . - group : block : picture)

arousal_best <- arousal_3

# Remove 2-way interactions
arousal_2_1 <- update(arousal_best, . ~ . - group : block) # Drop
arousal_2_2 <- update(arousal_best, . ~ . - group : picture) # Drop
arousal_2_3 <- update(arousal_best, . ~ . - block : picture) # Drop

arousal_best <- update(arousal_best, . ~ . - group:block - group:picture - block:picture)

# We keep all main effects
summary(arousal_best)
```

- There is a clear and strong effect of the picture type as negative pictures are associated with a higher subjective arousal compared to the neutral pictures. 
- There is a weak block effect, that shows that arousal evaluations are slightly decreasing over time.

# Subjective valence

```{r plot subjective valence, echo=FALSE}
# Subjective valence
plot_emot_valence <-
    scr_era %>%
    filter(session == "emot") %>% 
    mutate(session = case_when(session == "emot" ~ "Emotion induction",
                               session == "recall" ~ "Recall")) %>% 
    group_by(session, block, group, picture) %>% 
    summarise(Mean = mean(valence, na.rm = TRUE),
              Se = sd(valence, na.rm = TRUE)/sqrt(n())) %>% 
    ggplot() +
        aes(x = block, y = Mean, group = picture, ymin = Mean - Se, ymax = Mean + Se) +
        geom_point() +
        geom_errorbar(width = .2) +
        geom_line(aes(linetype = picture), size = 1) +
        coord_cartesian(ylim = c(1, 9)) +
        scale_x_continuous("Block", breaks = 1:3) +
        scale_y_continuous("Mean (SEM) of subjective valence") +
        guides(linetype = "none") +
        facet_grid(group ~ session) +
        theme(strip.text.y = element_blank())

plot_recall_valence <-
    scr_era %>%
    filter(session == "recall") %>% 
    mutate(session = case_when(session == "emot" ~ "Emotion induction",
                                   session == "recall" ~ "Recall")) %>% 
    group_by(session, group, picture, novelty) %>% 
    summarise(Mean = mean(valence, na.rm = TRUE),
              Se = sd(valence, na.rm = TRUE)/sqrt(n())) %>% 
    ggplot() +
        aes(x = novelty, y = Mean, group = picture, ymin = Mean - Se, ymax = Mean + Se) +
        geom_point() +
        geom_errorbar(width = .2) +
        geom_line(aes(linetype = picture), size = 1) +
        coord_cartesian(ylim = c(1, 9)) +
        scale_x_discrete("Novelty") +
        scale_y_continuous(NULL) +
        facet_grid(group ~ session) +
        theme(axis.text.y = element_blank(),
              axis.ticks = element_blank()) +
        labs(linetype = "Picture")

plot_emot_valence + 
    plot_recall_valence +
    plot_layout(widths = c(3,2))

```
```{r modeling valence}
valence_lm <- lm(valence ~ group * block * picture, data = scr_era)
valence_i <- lmer(valence ~ group * block * picture + (1 | id), data = scr_era)
valence_is <- lmer(valence ~ group * block * picture + (block : group : picture | id), data = scr_era)

# Remove 3 way interaction
valence_best <- valence_i
# Note that we use the random intercept model, however the random intercept+slope model may have a better fit (although it fails to converge properly). The optimal random structure is yet to be found.
valence_3 <- update(valence_best, . ~ . - group : block : picture)

valence_best <- valence_3

# Remove 2-way interactions
valence_2_1 <- update(valence_best, . ~ . - group : block) # Drop
valence_2_2 <- update(valence_best, . ~ . - group : picture) # Drop
valence_2_3 <- update(valence_best, . ~ . - block : picture) # Keep

valence_best <- update(valence_best, . ~ . - group:block - group:picture)

# We keep all main effects
summary(valence_best)
```

- There is a clear and strong effect of the picture type as negative pictures are associated with a lower subjective valence compared to the neutral pictures. 
- There is a weak interaction between block and picture type, that shows that there can be a difference between the habituation of negative and neutral pictures.
- There is a weak block effect, that shows that valence evaluations are slightly decreasing over time.

# Skin Conductance Response (SCR)
## Data processing
- Skin conductance was recorded using a sampling rate of 32 Hz
- Ledalab toolbox was used to down-sample data to 16 Hz, use continuous decomposition analysis with optimized parameters to separate tonic (SCL) and phasic (SCR) skin conductance. SCR was calculated using a response window of 1 to 4 sec after stimuli presentation, with a minimum amplitude threshOld criterion of 0.01 muS. 

```{r plotting SCR, echo=FALSE}
# Plotting SCR
plot_emot_scr <-
    scr_era %>%
    filter(session == "emot") %>% 
    mutate(session = case_when(session == "emot" ~ "Emotion induction",
                               session == "recall" ~ "Recall")) %>% 
    group_by(session, block, group, picture) %>% 
    summarise(Mean = mean(scr_sqrt, na.rm = TRUE),
              Se = sd(scr_sqrt, na.rm = TRUE)/sqrt(n())) %>% 
    ggplot() +
        aes(x = block, y = Mean, group = picture, ymin = Mean - Se, ymax = Mean + Se) +
        geom_point() +
        geom_errorbar(width = .2) +
        geom_line(aes(linetype = picture), size = 1) +
        coord_cartesian(ylim = c(-0.4, .75)) +
        scale_x_continuous("Block", breaks = 1:3) +
        scale_y_continuous("Mean (SEM) of skin counductance response") +
        guides(linetype = "none") +
        facet_grid(group ~ session) +
        theme(strip.text.y = element_blank())

plot_recall_scr <-
    scr_era %>%
    filter(session == "recall") %>% 
    mutate(session = case_when(session == "emot" ~ "Emotion induction",
                               session == "recall" ~ "Recall")) %>% 
    group_by(session, group, picture, novelty) %>% 
    summarise(Mean = mean(scr_sqrt, na.rm = TRUE),
           Se = sd(scr_sqrt, na.rm = TRUE)/sqrt(n())) %>% 
    ggplot() +
        aes(x = novelty, y = Mean, group = picture, ymin = Mean - Se, ymax = Mean + Se) +
        geom_point() +
        geom_errorbar(width = .2) +
        geom_line(aes(linetype = picture), size = 1) +
        coord_cartesian(ylim = c(-0.4, .75)) +
        scale_x_discrete("Novelty") +
        scale_y_continuous(NULL) +
        facet_grid(group ~ session) +
        theme(axis.text.y = element_blank(),
              axis.ticks = element_blank())

plot_emot_scr + 
    plot_recall_scr +
    plot_layout(widths = c(3,2))

```

```{r scr model building}
# Using Zuur method to select random structure
# Simple linear regression to justify lmer
model_lm <- lm(scr ~ group * block * picture, data = df_sum)
# Random intercept
model_i <- lmer(scr ~ group * block * picture + (1 | id), data = df_sum)
# Random intercept and splope
model_is <- lmer(scr ~ group * block * picture + (block : group : picture | id), data = df_sum)

# anova(model_i, model_lm)
# anova(model_i, model_is)

# The random intercept model is the best
#summary(model_i)

# Remove 3 way interaction
model_best <- model_i
model_3 <- update(model_best, . ~ . - group : block : picture)

# anova(model_best, model_3)
model_best <- model_3  # Drop 3-way interaction
#summary(model_best)

# Remove 2-way interactions
model_2_1 <- update(model_best, . ~ . - group : block)
model_2_2 <- update(model_best, . ~ . - group : picture)
model_2_3 <- update(model_best, . ~ . - block : picture)

# anova(model_best, model_2_1) # Drop
# anova(model_best, model_2_2) # Drop
# anova(model_best, model_2_3) # Keep
model_best <- update(model_best, . ~ . - group:block - group:picture)

# Remove main effects
# Remove 2-way interactions
model_1_1 <- update(model_best, . ~ . - block)
model_1_2 <- update(model_best, . ~ . - group)
model_1_3 <- update(model_best, . ~ . - picture)

# anova(model_best, model_1_1) # Can't remove
# anova(model_best, model_1_2) # Drop
# anova(model_best, model_1_3) # Keep

model_best <- update(model_best, . ~ . - group)

summary(model_best)
```

- There was no main or interaction effect of nightmare group membership on SCR 
- SCR decreased in each subsequent block, showing signs of habituation
- Negative pictures were associated with larger SCR

## SCR habituation before and after sleep

```{r}
sleep_sum %>% 
    ggplot() +
    aes(x = sleep, y = scr_mean, ymin = scr_mean - scr_se, ymax = scr_mean + scr_se, group = picture) +
    geom_point() +
    geom_line(aes(linetype = picture), size = 1.2) +
    geom_errorbar(width = .2) +
    facet_grid(group ~ .)

lmer(scr ~ group * picture * sleep + (1 | id), data = sleep_df) %>% 
    summary()


```

Finding: There was no evidence for a difference in SCR before and after sleep.

# Heart rate deceleration (HDR)
## Data processing
- ECG data was collected using a sampling rate of 1024 Hz
- Movement drift was removed from the data using a moving average with a window of 1024 samples
- Data was down-sampled to 128 Hz
- IBIs were identified using a global threshOld in Artiifact, and corrected manually.
- Artifacts were identified using the Berntson method, and replaced using cubic spline interpolation
- Artifact corrected IBIs were used to estimate heart rate for each half second, using cubic spline interpolation.
- Heart rate deceleration (HRD) was calculate as the minimum heart rate in a 3s window after presentation for each stimulus, relative to the moment of presentation
- HRD was averaged for each stimuli type (neutral vs. negative) for each participant, and each block.

## Exploratory data analysis on data quality
### Number of artifacts in the IBI data
First we check the percentage of artifacts in each recording. According to the following plot, the number of corrected artifacts in the sample was low (<3%).

```{r hrd artifacts}
ibi <-
tibble(artifact_file = dir_ls(path = "all_data/artifact_corrected_ibi_berntson/", regexp = "IBI_artifacts_IBIs_from_"),
       corrected_file = dir_ls(path = "all_data/artifact_corrected_ibi_berntson/", regexp = "IBI_artifactCorrected_IBIs_from_")
       ) %>% 
    transmute(id = str_extract(artifact_file, "\\d+"),
              session = str_replace(artifact_file, ".*_\\d+_(\\w+)_ECG.txt.csv$", "\\1"),
              artifact_data = map(artifact_file, ~read_csv(.x, col_types = "di")),
              corrected_data = map(corrected_file, ~read_csv(.x, col_types = "d")),
              data = map2(artifact_data,
                          corrected_data,
                          ~bind_cols(.x, .y))
                      ) %>%
    unnest(data) %>% 
    rename(ibi = IBI, ibi_corrected = IBI_artefactCorrected)


ibi %>% 
    group_by(id, session) %>% 
    summarise(artifact_n = sum(artifact),
              artifact_p = sum(artifact)/n()) %>% 
    ggplot() +
    aes(x = artifact_p, color = session, fill = session) +
    scale_x_continuous(labels = scales::percent_format()) +
    geom_freqpoly(size = 1.3, alpha = .7) +
    labs(title = "Frequency of artifacts as a percentage of the whole recoring",
         y = "Number of cases",
         x = "Percentage of the whole recording")
```

### Number of markers/participants in the data analysis
It seems like most data can be matched to markers. However participant 47 has only 6 successfully matched markers in the emot session.
```{r}

# Nudge data points to the closest half second. This decreases marker accuracy somewhat (from perfect accuracy, they become quarter-of-a-second accurate, which should be enough if we consider that HRD is calculated in a 3 second window)
markers_hrd <- 
    markers %>% 
    mutate(time = plyr::round_any(time,.5)) %>% 
    drop_na(block) %>%
    arrange(id, session, time)

hr_data %>% 
    inner_join(markers_hrd, by = c("id", "session", "time")) %>% 
    mutate(id = as_factor(id), session = as_factor(session)) %>% 
    group_by(id, session) %>% 
    count() %>% 
    ggplot() +
    aes(x = fct_rev(id), y = n, fill = session, label = n) +
    geom_col(position = "dodge") +
    geom_text() +
    coord_flip() +
    labs(title = "Successfully matched markers for each session",
         y = "Number of matched markers",
         x = "Participant id")

```

## Effect of stimuli on HRD
```{r}
# Prepare data for visualization
hr_6s <-
    hr_data %>% 
    # Join markers to the heart rate data
    left_join(markers_hrd, 
              by = c("id", "session", "time")) %>% 
    group_by(session, id) %>% 
    # Fill the missing data (last value carry forward)
    fill(block, stimulus, order, valence, arousal, familiarity, picture) %>%
    select(-order, -valence, -arousal, -familiarity) %>% 
    group_by(id, session, stimulus, block) %>% 
    # Keep only the 6 seconds after stimuli presentation
    slice(0:12) %>% 
    # Calculate relative time and heart rate (compared to stimuli presentation)
    mutate(rel_time = time - first(time),
           hr_change = hr - first(hr)) %>% 
    ungroup() %>% 
    # Join only those that were not excluded from the sample 
    right_join(participants, by = "id") %>% 
    drop_na(session, block) %>% 
    arrange(id, session, block, stimulus, rel_time)
```


```{r}
# Change in HR after stimuli presentation (all participants/sessions)
hr_6s %>% 
    group_by(picture, rel_time) %>% 
    summarise(hr_change = mean(hr_change, na.rm = TRUE)) %>% 
    ggplot() +
    aes(x = rel_time, y = hr_change, color = picture) +
    geom_smooth(method = "loess") +
    labs(title = "Change in heart rate after stimuli presentation (all participants/sessions)",
         x = "Time (s)",
         y = "Heart rate change (bpm)")
```

```{r}
# Change by session
hr_6s %>% 
    group_by(id, session, group, picture, rel_time) %>% 
    summarise(hr_change = mean(hr_change, na.rm = TRUE)) %>% 
    ggplot() +
        aes(x = rel_time, y = hr_change, color = picture) +
        geom_smooth(method = "loess") +
        facet_grid(group~session) +
        labs(title = "Change in heart rate after stimuli presentation in sessions",
             x = "Time (s)",
             y = "Heart rate change (bpm)")
```


```{r}
# Change in heart rate after stimuli presentation in the emot session by block
hr_6s %>% 
    filter(session == "emot") %>% 
    group_by(id, group, picture, rel_time, block) %>% 
    summarise(hr_change = mean(hr_change, na.rm = TRUE)) %>% 
    arrange(id, block, picture, rel_time) %>% # Just for checking values
    ggplot() +
        aes(x = rel_time, y = hr_change, color = picture) +
        geom_smooth(method = "loess") +
        facet_grid(group~block) +
        labs(title = "Change in heart rate after stimuli presentation in the emot session by block",
             x = "Time (s)",
             y = "Heart rate change (bpm)")
```


```{r}
# Change in heart rate after stimuli presentation in all sessions
hr_6s %>% 
    group_by(group, picture, rel_time) %>% 
    summarise(hr_change = mean(hr_change, na.rm = TRUE)) %>% 
    ggplot() +
    aes(x = rel_time, y = hr_change, color = picture) +
    geom_smooth(method = "loess") +
    facet_grid(group ~ .) +
    labs(title = "Change in heart rate after stimuli presentation in all sessions",
         x = "Time (s)",
         y = "Heart rate change (bpm)")
```

## Calculate Hear rate deceleration
The minimum of heart rate after stimuli presentation in a 3 second frame.
```{r}
hrd <-
    hr_data %>% 
    # Join markers to the heart rate data
    left_join(markers_hrd, 
              by = c("id", "session", "time")) %>% 
    group_by(session, id) %>% 
    # Fill the missing data (last value carry forward)
    fill(block, stimulus, order, valence, arousal, familiarity, picture) %>%
    select(-order, -valence, -arousal, -familiarity) %>% 
    group_by(id, session, block, stimulus) %>% 
    # Keep only the 6 seconds after stimuli presentation
    slice(0:6) %>% 
    # Calculate relative time and heart rate (compared to stimuli presentation)
    mutate(rel_time = time - first(time),
           hr_change = hr - first(hr)) %>% 
    group_by(id) %>% 
    mutate(hr_change_std = scale(hr_change)) %>% 
    ungroup() %>% 
    filter(abs(hr_change_std) < 3.5) %>% 
    # Join only those that were not excluded from the sample 
    right_join(participants, by = "id") %>% 
    drop_na(session, block) %>% 
    group_by(id, session, block, stimulus, picture, group, gender, pic_set) %>% 
    summarise(hrd = min(hr_change, na.rm = TRUE),
              hrd_std = min(hr_change_std, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(novelty = case_when(
        session == "recall" & pic_set == "A" & stimulus %in% set_a ~ "Old",
        session == "recall" & pic_set == "A" & !(stimulus %in% set_a) ~ "New",
        session == "recall" & pic_set == "B" & stimulus %in% set_b ~ "Old",
        session == "recall" & pic_set == "B" & !(stimulus %in% set_b) ~ "New",
        TRUE ~ NA_character_) %>% 
            factor(., levels = c("Old", "New"))) %>% 
    mutate(block = if_else(session == "recall", 
                           NA_integer_, 
                           block)) %>% 
    arrange(id, session, block, stimulus)

hrd %>% 
    ggplot() +
    aes(x = sqrt(-hrd_std+1)) +
    geom_histogram()
```


```{r}
plot_emot_hrd <-
    hrd %>%
    filter(session == "emot") %>% 
    mutate(session = case_when(session == "emot" ~ "Emotion induction",
                               session == "recall" ~ "Recall")) %>% 
    group_by(session, block, group, picture) %>% 
    summarise(Mean = mean(hrd_std, na.rm = TRUE),
              Se = sd(hrd_std, na.rm = TRUE)/sqrt(n())) %>% 
    ggplot() +
        aes(x = block, y = Mean, group = picture, ymin = Mean - Se, ymax = Mean + Se) +
        geom_point() +
        geom_errorbar(width = .2) +
        geom_line(aes(linetype = picture), size = 1) +
        coord_cartesian(ylim = c(-1.0, -.4)) +
        scale_x_continuous("Block", breaks = 1:3) +
        scale_y_continuous("Mean (SEM) of Hear Rate Deceleration") +
        guides(linetype = "none") +
        facet_grid(group ~ session) +
        theme(strip.text.y = element_blank()) +
        NULL

plot_recall_hrd <-
    hrd %>%
    filter(session == "recall") %>% 
    mutate(session = case_when(session == "emot" ~ "Emotion induction",
                               session == "recall" ~ "Recall")) %>% 
    group_by(session, group, picture, novelty) %>% 
    summarise(Mean = mean(hrd_std, na.rm = TRUE),
              Se = sd(hrd_std, na.rm = TRUE)/sqrt(n())) %>% 
    ggplot() +
        aes(x = novelty, y = Mean, group = picture, ymin = Mean - Se, ymax = Mean + Se) +
        geom_point() +
        geom_errorbar(width = .2) +
        geom_line(aes(linetype = picture), size = 1) +
        coord_cartesian(ylim = c(-1.0, -.4)) +
        scale_x_discrete("Novelty") +
        scale_y_continuous(NULL) +
        facet_grid(group ~ session) +
        theme(axis.text.y = element_blank(),
              axis.ticks = element_blank()) +
        NULL

plot_emot_hrd + 
    plot_recall_hrd +
    plot_layout(widths = c(3,2))
```









